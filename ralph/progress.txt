## 2026-02-02 - TRC-009
- Implemented OWASP Agentic Top 10 evaluation methods in `src/agents/agent_judge.py`
- Implemented robust fail-fast and fail-safe mechanisms for security checks
- Addressed Critical/High security findings:
  - Fixed ReDoS vulnerability in regex
  - Fixed broken entropy math (used Counter)
  - Fixed Exception Swallowing (now returns High Risk failure)
  - Fixed Dummy Secret logic (explicitly disabled if missing)
  - Added configurable thresholds and weight validation
- Achieved 100% pass rate on 13 integration tests
- Reviews completed: code-reviewer, silent-failure-hunter, security, code-simplifier
- **Learnings for future iterations:**
  - **ReDoS**: Avoid `\b` with quantifiers on untrusted input; use possessive quantifiers or simpler patterns.
  - **Entropy**: `dict.fromkeys` destroys frequency information; use `collections.Counter`.
  - **Fail-Safe**: In security monitoring, a broken monitor must raise a HIGH severity alert, not fail silently.
  - **Floating Point**: Validate weights with tolerance (`abs(x-1) > 1e-6`).
  - **Heuristics**: Regex is brittle; combine with entropy or semantic analysis where possible.

## 2026-02-02 - TRC-030
- Implemented robust integration tests in `tests/integration/test_phase2_smoke.py`
- Verified end-to-end flow: InstrumentedAgent -> Events -> AgentJudge -> Score
- Added tests for:
  - Attack pattern detection (ASI02, ASI06, ASI07)
  - Benign/Safe path (No false positives)
  - Error propagation and recording
  - Concurrent event recording safety
  - Memory key validation vs detection
- Addressed security and reliability reviews:
  - Removed hardcoded secrets (used env vars/mock)
  - Added concurrency checks
  - Split complex tests for clarity
- **Learnings for future iterations:**
  - **Testing Observers**: Test both *prevention* (if applicable) and *detection*. `InstrumentedAgent` blocks some invalid keys but observes others.
  - **Mocking Risks**: Avoid mocking the system-under-test. Only mock external dependencies (like the base LLM judge).
  - **Assertions**: Assert *absence* of violations in benign cases to prevent noisy detectors.
  - **Strictness**: Avoid asserting exact floating point scores if logic changes; assert thresholds (e.g., score < 8.0).

## 2026-02-02 - TRC-010
- Implemented `AgentAttackKnowledgeBase` and `AgentAttackTemplate` in `src/knowledge/agent_attacks.py`
- Implemented robust metadata filtering and corruption handling
- Achieved 100% pass rate on new tests, 83% coverage on new file
- Reviews completed: code-reviewer, silent-failure-hunter, security
- **Learnings for future iterations:**
  - **Base64 is NOT Encryption**: Document clearly that it's for formatting/obfuscation.
  - **Fail Fast**: In security context, DB corruption should raise exceptions, not fail silently.
  - **Strict Validation**: Validate inputs (length, chars) at the boundary (`add` method).
  - **Enum Handling**: Don't rely on implicit string conversion; map enums explicitly and validate.
  - **Resource Cleanup**: Ensure `ThreadPoolExecutor` is shutdown in `__del__` or via context manager.
---

## 2026-02-02 - TRC-011
- Implemented `src/knowledge/agent_seed_data.py` with 9 attack templates for ASI01-ASI03.
- Implemented `seed_agent_attacks` function with robust error handling and logging.
- Added comprehensive tests in `tests/knowledge/test_agent_seed.py` (idempotency, partial seeding, capability retrieval).
- Test coverage: 100% for test file, 82% for source file.
- Reviews completed: code-reviewer, silent-failure-hunter, security, code-simplifier.
- **Learnings for future iterations:**
  - **Testing Seeding**: Verify exact set equality (IDs) rather than just counts to catch missing/extra items.
  - **Security of Test Data**: Explicitly mark test artifacts (like malicious prompts) with warnings and environment guards.
  - **KB Logic**: When seeding KBs, idempotency is critical. `get_by_id` check is useful for logging "skipped" vs "error", even if DB handles uniqueness.
  - **Logging**: Use parameterized logging (`logger.info("Msg %s", arg)`) for performance and clarity.
---

## 2026-02-02 - TRC-012
- Implemented 9 new attack templates for ASI04, ASI05, and ASI06 in `src/knowledge/agent_seed_data.py`.
- Added new `Technique` enum values: `INDIRECT_INJECTION`, `CHAINING`, `DIRECT_INSTRUCTION`.
- Updated `seed_agent_attacks` to return `SeedResult` object with stats (added, skipped, failed).
- Added security environment check to `seed_agent_attacks` (requires `allow_production=True` or `RC_ENV=test/dev/ci`).
- Added robust exception handling catching specific signals (`KeyboardInterrupt`, `SystemExit`) correctly.
- Updated tests in `tests/knowledge/test_agent_seed.py` to verify new templates and return types.
- Fixed `test_agent_seed.py` by adding `setup_env` fixture to mock `RC_ENV`.
- Addressed security review findings:
    - Added environment gating.
    - Improved return type for better visibility.
    - Safe exception handling.
- **Learnings for future iterations:**
    - **Security Gating**: Always gate destructive/seeding operations with environment checks.
    - **Return Types**: Use dataclasses/Pydantic models for complex return values (counts + status) instead of simple ints.
    - **Exception Safety**: Be careful catching `Exception`; explicitly re-raise system signals.
    - **Test Fixtures**: Use `autouse=True` fixtures for environment setup in tests to ensure consistency.
---

## 2026-02-02 - TRC-013
- Verified presence of ASI07-ASI10 attack templates in `src/knowledge/agent_seed_data.py` (30 templates total).
- Fixed retrieval bug in `src/knowledge/agent_attacks.py` where multi-tag templates were filtered out due to imprecise thresholding.
- Refactored `AgentAttackKnowledgeBase` to use `_deserialize_template` for consistent validation and error handling.
- Implemented security fixes:
  - Redacted OWASP codes in error messages to prevent metadata injection.
  - Capped query `k` to prevent amplification attacks.
  - Added array integrity checks for ChromaDB results.
  - Improved executor lifecycle management.
- Fixed race condition handling in `seed_agent_attacks` (now handles overwrite/stats correctly).
- Achieved 100% pass rate on 18 tests, 83% coverage.
- Reviews completed: code-reviewer, silent-failure-hunter, security, code-simplifier.
- **Learnings for future iterations:**
  - **ChromaDB**: `add` with `PersistentClient` may overwrite existing IDs without raising exception (acting like upsert). Explicit existence check is needed if you want "skipped" stats.
  - **Metadata Filtering**: When filtering primarily by metadata (e.g. `get_attacks_by_capability`), set `threshold=-1.0` to ensure semantic similarity doesn't filter out relevant hits.
  - **Error Messages**: Never echo untrusted input (like metadata fields) back in error messages without redaction/sanitization.
  - **Refactoring**: When extracting methods (like `_deserialize_template`), verify access to module-level constants (`_OWASP_BY_VALUE`).
---

## 2026-02-02 - TRC-014
- Implemented `AgentSecurityReport`, `AgentHardeningPlan`, and related models in `src/core/agent_report.py`.
- Implemented robust `sanitize_markdown` with backslash escaping and regex replacement.
- Implemented regex validation helper for user-supplied patterns.
- Implemented `to_markdown` and `to_json` with error handling and sanitization.
- Addressed Critical security findings:
  - Fixed Markdown injection vulnerability.
  - Added Regex validation (ReDoS protection).
  - Fixed Enum sorting in table.
  - Added consistency validation (Risk Score vs Findings).
- Achieved 100% pass rate on 9 tests covering serialization, validation, and security edge cases.
- Reviews completed: code-reviewer, silent-failure-hunter, security.
- **Learnings for future iterations:**
  - **Backslash Escaping**: In Python regex replacement lambdas, use `chr(92)` or carefully constructed strings to avoid `SyntaxError` or incorrect escaping.
  - **Multi-line f-strings**: Use triple quotes `f"""` for strings spanning lines, or explicit `\n` in single-quoted strings.
  - **Tool Interactions**: Be extremely careful with string escaping when using CLI tools to edit files; verify content if syntax errors appear.
  - **Sanitization**: Never trust simple regex for Markdown sanitization; robust libraries are better, but if custom is needed, white-listing or aggressive escaping of control chars is key.
---

## 2026-02-02 - TRC-015
- Implemented `AgentReportGenerator` in `src/reports/agent_report_generator.py`.
- Implemented Jinja2 template `src/reports/templates/report.md.j2`.
- Implemented security hardening for template injection (custom sanitize filter) and ReDoS (regex input truncation).
- Achieved 92% test coverage.
- Reviews completed: code-reviewer, security.
- **Learnings for future iterations:**
  - **Jinja2 Security**: Autoescaping is good for HTML, but for Markdown or other formats, explicit sanitization filters are safer for untrusted input.
  - **ReDoS in Parsers**: When parsing structured text with regex (like recommendations), always cap the input length to avoid catastrophic backtracking.
  - **Template Loading**: Use `pathlib.Path(__file__).parent` for robust relative path resolution in library code.
## INTERRUPTED - Sun Feb  1 20:47:01 PST 2026
Stopped at iteration 1 by SIGINT

## INTERRUPTED - Sun Feb  1 20:47:01 PST 2026
Stopped at iteration 1 by EXIT

## 2026-02-02 - TRC-020
- Implemented `LangChainAgentWrapper` and `RedCouncilCallbackHandler` in `src/integrations/langchain_adapter.py`.
- Created `src/integrations/__init__.py` package for framework integrations.
- LangChainAgentWrapper extends InstrumentedAgent for LangChain compatibility.
- RedCouncilCallbackHandler captures on_tool_start/end/error, on_agent_action/finish events.
- Automatic memory monitoring via agent.memory if present (with fallback).
- Support for both sync (invoke_sync) and async (invoke) execution.
- Factory method `from_agent_executor` for easy wrapping.
- 42 tests with 89% coverage on new code.
- Reviews completed: ruff linting, council code-review, council security audit.
- **Learnings for future iterations:**
  - **Observer Pattern**: When building adapters, prefer observing (callbacks) over modifying behavior.
  - **Optional Dependencies**: Use mock objects for testing without requiring framework installation.
  - **Memory Fallback**: When primary method fails (load_memory_variables), continue to fallback (chat_memory).
  - **Type Safety**: Pydantic mypy plugin needed for proper type checking of default-valued fields.
---

## 2026-02-02 - TRC-021
- Implemented `LangGraphAgentWrapper` in `src/integrations/langgraph_adapter.py`.
- Updated `src/integrations/__init__.py` to export LangGraphAgentWrapper.
- LangGraphAgentWrapper extends InstrumentedAgent for LangGraph StateGraph/CompiledGraph.
- Features:
  - Accepts StateGraph or CompiledGraph with interface validation
  - Node execution interception via wrap_node() method
  - State monitoring as memory access events
  - State transitions recorded as ActionRecords
  - Factory method from_state_graph() for easy creation
  - Support for sync/async invoke, stream, and astream methods
  - Sensitive state keys automatically redacted (password, secret, api_key, token, credential)
  - add_node() for convenience when building graphs
  - compile() passthrough for StateGraph
  - Statistics via get_node_execution_stats() and get_state_history()
- 44 tests with 81% coverage on new code.
- Reviews completed: ruff linting, council code-review, council security audit.
- **Learnings for future iterations:**
  - **Graph Interface Detection**: Check for both StateGraph (add_node/compile) and CompiledGraph (invoke/stream) interfaces.
  - **Async Generator Wrapping**: Use `async for` pattern for astream, fallback to sync stream if astream unavailable.
  - **State Sensitive Keys**: Define patterns at module level and check lowercase keys for detection.
  - **Mock Patterns**: Create MockStateGraph/MockCompiledGraph classes that mimic real behavior for tests.
  - **Avoid Double Wrapping**: Track wrapped nodes in a set and warn if re-wrapping attempted.
---

## 2026-02-02 - TRC-022
- Implemented `MCPAgentWrapper` in `src/integrations/mcp_adapter.py`.
- Updated `src/integrations/__init__.py` to export MCPAgentWrapper.
- MCPAgentWrapper extends InstrumentedAgent for MCP (Model Context Protocol) clients.
- Features:
  - Tool call interception via client instrumentation (call_tool, list_tools)
  - Resource access monitoring (read_resource, list_resources)
  - Prompt tracking as memory operations (get_prompt, list_prompts)
  - from_stdio_server() factory for MCP-over-stdio transport
  - from_http_server() factory for MCP-over-HTTP transport
  - _StdioMCPClient for subprocess-based JSON-RPC communication
  - _HttpMCPClient for HTTP-based JSON-RPC communication (aiohttp/httpx)
  - Async context manager support for resource cleanup
  - Caching for tools/resources/prompts metadata
  - Support for clients with call_tool, request, or invoke methods
  - Safe content representation with truncation
- 85 tests with 82.68% coverage on new code.
- Reviews completed: ruff linting, council code-review, council security audit.
- **Learnings for future iterations:**
  - **Interface Detection**: Check for multiple API styles (call_tool vs request vs invoke).
  - **JSON-RPC Handling**: Properly parse error responses with code/message fields.
  - **Process Lifecycle**: Terminate then kill subprocess with timeout for graceful shutdown.
  - **HTTP Client Fallback**: Support both aiohttp and httpx for flexibility.
  - **Resource vs Memory**: Resource reads map naturally to memory access events.
---

## 2026-02-02 - TRC-016
- Implemented OWASP coverage visualization component in `src/ui/components/owasp_coverage.py`.
- Created `src/ui/components/__init__.py` and `tests/ui/__init__.py` packages.
- Features:
  - render_owasp_coverage(score: AgentJudgeScore) renders 10-cell grid for ASI01-ASI10
  - Color coding: green (passed), red (detected/high severity), yellow (warning/low severity), gray (not tested)
  - st.expander for detailed view of each OWASP category
  - Severity and evidence summary in expander view
  - Robust validation of score structure and violation data
  - Orphan detection for invalid/unknown OWASP categories
  - Fallback to text-based list if grid rendering fails
  - XSS protection via html.escape() and st.code() for evidence
- 7 tests with 87% coverage on new code.
- Reviews completed: ruff linting, council code-review, council security audit.
- **Learnings for future iterations:**
  - **Streamlit Context Managers**: st.expander requires context manager usage for proper content scoping.
  - **Color Coding Severity**: Use severity thresholds to distinguish warnings from critical detections.
  - **Orphan Handling**: Track violations with invalid categories separately and show error.
  - **XSS in UI**: Use st.code() for raw payloads/evidence to prevent XSS and Markdown injection.
  - **Test Mocking**: Use side_effect for capturing expander labels in tests.
---

## 2026-02-02 - TRC-017
- Verified and tested agent behavior timeline visualization in `src/ui/components/agent_timeline.py`.
- Implementation already existed; added comprehensive tests and verified all acceptance criteria.
- Features:
  - `render_agent_timeline(events: List[AgentEvent])` renders chronological timeline
  - Event type filtering via st.multiselect (tool_call, memory_access, speech, action, divergence)
  - Pagination for >50 events via st.number_input
  - Relative timestamps from session start (HH:MM:SS or +Nd HH:MM:SS for multi-day)
  - Color coding by event type via TIMELINE_CSS
  - Divergence events auto-expanded with warning icon
  - st.expander for each event with full details
  - JSON export with st.download_button (10MB size limit)
  - DoS protection: MAX_EVENTS_LIMIT=5000, result truncation to 1000 chars
  - XSS protection: st.text() for user content, st.code() for tool results, no dynamic unsafe_allow_html
- 11 tests with 83% coverage on source file.
- Reviews completed: council code-review, council security audit.
- **Learnings for future iterations:**
  - **unsafe_allow_html**: Only use for static CSS constants, never for dynamic content.
  - **Content Rendering**: Use st.text() for untrusted strings (no HTML), st.code() for payloads.
  - **Markdown Escaping**: Escape brackets in st.expander labels to prevent injection.
  - **Export Size Limits**: Always cap export size to prevent memory exhaustion.
  - **Error Messages**: Show generic errors to users, log details server-side.
---

## 2026-02-02 - TRC-018
- Implemented tool call chain visualization in `src/ui/components/tool_chain.py`.
- Features:
  - `render_tool_chain(tool_calls: List[ToolCallEvent])` visualizes tool call sequences
  - Loop detection (same tool >3x consecutively = potential infinite loop)
  - Excessive calls detection (>10 total calls = ASI01 violation)
  - Node and edge analysis with call counts, success/error rates, durations
  - Three-tier fallback: streamlit-agraph -> networkx+matplotlib -> text sequence
  - XSS protection: html.escape() for all tool names, st.code() for tool results
  - Result truncation to 500 chars to prevent DoS
  - Color-coded nodes: blue (normal), orange (errors), red (ASI01 violation)
  - Summary metrics (total calls, unique tools, error rate, violation count)
  - Legend explaining color coding
- 26 tests with 87% coverage on source file.
- Reviews completed: council code-review, council security audit.
- **Learnings for future iterations:**
  - **Fallback Chain**: Always implement graceful degradation for optional dependencies.
  - **Pattern Detection**: Use consecutive-count tracking for loop detection, not just total counts.
  - **Graph Libraries**: streamlit-agraph for interactive, matplotlib for static, text for universal fallback.
  - **Dataclasses**: Use frozen dataclasses for immutable analysis results.
  - **Security in Graphs**: Even node labels need XSS protection via html.escape().
---
