## Codebase Patterns
- **GIT GOTCHA**: `frontend/lib/` is ignored by root `.gitignore`. Use `git add -f` for files in this directory.
- **JSON Security**: Static JSON files driving UI should be treated as untrusted input; Zod validation != sanitization.
- `QueryProvider` configured in `frontend/components/providers/` with retry/refetch logic.
- Use `isError` prop in display components to distinguish empty states from failures.
- Wrap navigation logic in `try/catch/finally` to handle router failures.
- safeLocalStorage helper in frontend/lib/persistence/safeLocalStorage.ts for secure storage
- ErrorBoundary component in frontend/components/ErrorBoundary.tsx for fault tolerance
- shadcn/ui components in frontend/components/ui/
- Zustand stores use immer middleware for immutable updates
- All API calls go through React Query hooks in frontend/hooks/
- Use cn() utility from lib/utils for className merging
- Form validation with zod schemas in frontend/lib/schemas/
- **VITEST GOTCHA**: Always use non-interactive mode (e.g., `pnpm exec vitest run`) to avoid hanging in watch mode.
- `isTestingMode` type guard for runtime validation of enums
- `onRehydrateStorage` with `migrate` for robust Zustand persistence
- `ErrorBoundary` wrapping for components with side-effects
- `useTransition` for navigation in Next.js App Router
- Pydantic models in src/core/ use Field() with descriptions
- All agent classes inherit from base classes in src/agents/
- ChromaDB collections follow naming convention: {domain}_attacks
- Pytest fixtures in tests/conftest.py for common setup
- Use pytest.mark.asyncio for async test functions
- **Concurrency**: Use `src.ui.async_utils.safe_run_async` instead of `asyncio.run` in Streamlit callbacks

## 2026-02-02 - TRC-043
- Implemented `src/ui/components/session_manager.py` with secure session management.
- Features: Save, Save As New, Load, Delete, List, Import.
- Security Hardening:
  - Canonical path check to prevent traversal.
  - Strict UUID validation.
  - Atomic writes (`tempfile` + `os.replace` + `os.fsync` + `chmod`).
  - Hard limits on event count (10k) and file size (50MB).
  - Input sanitization for tags, names, descriptions.
- Created `tests/ui/test_session_manager.py` with 14 tests covering security edge cases.
- Achieved 81% coverage for `session_manager.py`.
- Reviews completed: code-review, security-audit (critical fixes applied).
- **Learnings for future iterations:**
  - **Security**: Always validate paths using `os.path.realpath` against expected directory root.
  - **Security**: Use atomic writes with restrictive permissions for sensitive data files.
  - **Testing**: `pytest-cov` requires careful setup when mocking modules; `patch.dict(sys.modules, ...)` works best.
  - **Mocking**: `json.load` mocking requires understanding how it reads from file-like objects (strings vs bytes).
---
## 2026-02-02 - TRC-044
- Implemented `src/ui/components/shortcuts.py` using JS injection via `st.components.v1.html`.
- Features: Ctrl+E (Eval), Ctrl+R (Report), Ctrl+Shift+D (Demo), Ctrl+Shift+N (New Session), Ctrl+Shift+C (Clear).
- Added `src/ui/async_utils.py` with `safe_run_async` to fix `asyncio.run` issues in Streamlit callbacks.
- Refactored `src/ui/dashboard.py` to use `safe_run_async` and import shortcuts.
- Security & Robustness:
  - Added debounce lock (500ms) to prevent double-clicks.
  - Added `disabled` attribute check before clicking buttons via JS.
  - Used `Ctrl+Shift` modifiers to avoid browser collisions (e.g. New Window).
  - Implemented exact text matching or strict inclusion logic.
- Tests: Created `tests/ui/test_shortcuts.py` validating JS injection content (100% coverage).
- **Learnings for future iterations:**
  - **Streamlit**: `asyncio.run` inside Streamlit callbacks is dangerous/brittle. Always use a helper that checks `get_running_loop()`.
  - **UI Hacks**: JS injection is effective for shortcuts but requires defensive coding (debounce, disabled checks) to be safe.
---
## 2026-02-02 - TRC-043/044 Security Fixes
- Hardened `session_manager.py` against Symlink TOCTOU using `_atomic_write` pattern and `O_NOFOLLOW` checks.
- Fixed FD leak in `load_session`.
- Hardened `SessionMetadata.sanitize` to clamp future dates (current_year + 5).
- Hardened `shortcuts.py` to strictly exclude password fields and restored restricted Tab navigation (currently removed for safety but help text preserved).
- Verified with comprehensive council review.
---

## 2026-02-02 - UI-001
- Implemented AppShell, Sidebar, and MobileNav components.
- Added ErrorBoundary and safeLocalStorage helper.
- Setup Vitest testing infrastructure with >90% coverage.
- Secured localStorage access and improved accessibility (ARIA, focus management).
- **Learnings for future iterations:**
  - **Hydration**: Use `mounted` state to prevent hydration mismatches when reading from localStorage.
  - **Security**: Always wrap localStorage access in try/catch to prevent DoS/crashes.
  - **Accessibility**: Use `aria-current="page"` for active links and `role="navigation"` landmarks.
  - **Testing**: Mocking `usePathname` and `Storage.prototype` works well for integration tests.
---
## 2026-02-02 - UI-002
- Implemented `ModeSelector` component and `testingMode` Zustand store.
- Features: LLM/Agent/Demo mode switching, unsaved changes confirmation, hydration safe.
- Security Hardening:
  - Runtime validation for persisted state and setMode updates.
  - Safe default fallback on rehydration failure.
  - `hasUnsavedChanges` excluded from persistence to avoid stale lockouts.
- Accessibility:
  - ARIA roles and labels for navigation and loading states.
  - `aria-busy` and `disabled` state during transitions.
  - `aria-live` region for mode change announcements.
- Tests: >94% coverage, including edge cases for navigation cancellation and rehydration validation.
- **Learnings for future iterations:**
  - **Zustand Persistence**: Always use `migrate` and `onRehydrateStorage` to validate data integrity.
  - **Next.js Navigation**: Use `useTransition` with `router.push` to track navigation state.
  - **UX**: Render a skeleton matching dimensions to avoid layout shift during hydration.
  - **Type Safety**: TypeScript enums/unions need runtime validation guards when crossing I/O boundaries (storage).
---
## 2026-02-02 - UI-003
- Implemented Dashboard with StatsCards, RecentActivity, and Quick Actions.
- Added QueryProvider for React Query integration with robust retry logic.
- Implemented mock API with mode-aware data generation.
- Achieved 91.5% test coverage.
- Reviews completed: code-review, silent-failure, security, accessibility (all critical issues fixed).
- **Learnings for future iterations:**
  - **Git Ignored Paths**: `frontend/lib/` is ignored by root `.gitignore` (matches Python `lib/`). ALWAYS check `git status` or use `git add -f` for files in `frontend/lib`.
  - **Accessibility**: Use `<ul>`/`<li>` instead of `role="list"`. Use `<time>` for dates. Add `aria-busy` to loading states.
  - **Robustness**: `router.push` is async and can fail; wrap navigation in try/catch.
  - **React Query**: Default configuration needs `staleTime` and `retry` logic to avoid silent failures.
  - **Mocking**: Mock data should be mode-aware (e.g. Demo Mode vs Live) to test UI reactivity.
---

## 2026-02-02 - UI-006
- Implemented WelcomeModal and onboarding store with Zustand persistence.
- Features: 3-path selection (Demo, Agent, LLM), persistence to localStorage, skip option.
- Achieved 87% test coverage.
- Reviews completed: code-review, silent-failure, security, accessibility.
- **Learnings for future iterations:**
  - **Accessibility**: Use native `<button>` elements inside Cards for proper keyboard navigation.
  - **Accessibility**: Ensure decorative icons have `aria-hidden="true"` and buttons have accessible names via `aria-labelledby`.
  - **Security**: Gate verbose error logs behind `process.env.NODE_ENV === 'development'`.
  - **State**: Use `merge` in Zustand persist middleware to validate schema of persisted data.
  - **React**: Use `mounted` state check to prevent hydration mismatches with localStorage.
---

## 2026-02-02 - UI-007
- Implemented `frontend/lib/demo/loadDemoSession.ts` and `demoData.ts` with Zod validation.
- Created `frontend/data/demo-events.json` with realistic security test scenario.
- Achieved 93% test coverage (90% lines).
- Implemented robust security measures: .max() limits, safe parsing, AbortSignal support.
- Added accessibility label maps and helpers.
- Reviews completed: code-review, silent-failure, security, accessibility (all critical issues fixed).
- **Learnings for future iterations:**
  - **Zod Validation**: Re-validating after mutation (`.parse`) is crucial when transforming data to ensure types don't drift.
  - **JSON Security**: Static JSON files should be treated as untrusted input if they drive UI; schema validation != sanitization.
  - **Git Ignore**: `frontend/lib/` is ignored by root `.gitignore`, use `git add -f`.
  - **Accessibility**: Define human-readable labels and descriptions in the data schema layer to support UI components.
---

## 2026-02-02 - UI-008
- Implemented QuickStartGuide and GuideStep components.
- Created GUIDE_STEPS data with contextual steps for LLM Testing, Agent Testing, and Demo Mode.
- Enhanced OnboardingStore with mode-scoped step completion tracking and hydration persistence.
- Features: 
  - Real-time progress tracking with Progress bar.
  - Expandable/collapsible floating card interface.
  - Completion celebrations per mode.
  - Robust accessibility (ARIA, keyboard navigation, live regions).
- Security & Robustness:
  - Whitelist-based state migration to prevent prototype pollution.
  - Sanitized mode string display.
  - Hydration guard to prevent flash of unstyled content.
  - Local ErrorBoundary for fault tolerance.
- Achieved 100% line coverage for new components.
- Reviews completed: code-review, silent-failure, security, accessibility (all critical issues fixed).
- **Learnings for future iterations:**
  - **Zustand Persistence**: `onRehydrateStorage` is essential for tracking when persisted state is ready to avoid UI "jumps".
  - **Security**: Whitelist keys in `migrate` instead of spreading the whole persisted object to prevent prototype pollution.
  - **Accessibility**: Nested interactive elements (like a button inside a clickable div) require careful event propagation management and ARIA coordination.
  - **Testing**: When mocking stores, ensure all exported utility functions (like `isTestingMode`) are also mocked, not just the store hook.
---

## 2026-02-02 - UI-009
- Implemented Onboarding Progress Indicator in Sidebar.
- Enhanced `useOnboardingStore` with strict type validation, safe merge logic, and dismissal state.
- Refactored `GUIDE_STEPS` to include navigation paths (`href`).
- Updated `Sidebar` to conditionally render progress indicator.
- Addressed significant code review feedback:
  - Improved accessibility (ARIA labels, semantic elements).
  - Hardened state persistence against prototype pollution and invalid keys.
  - Used `next/link` for navigation instead of buttons.
  - Memoized expensive calculations.
- Achieved >90% test coverage for new components.
- Reviews completed: code-review (critical issues fixed).
- **Learnings for future iterations:**
  - **Zustand Persistence**: `merge` function must be as strict as `migrate`. Shallow spreads are dangerous.
  - **Testing**: `vi.mock` factory hoisting means mocks must be defined inside the factory or using `vi.fn()` directly. `vi.mocked()` helper is essential for Type Safety.
  - **Linting**: `pnpm lint` (next lint) seems to have issues with current working directory or arguments in this environment. Rely on `tsc` and `vitest` for correctness.
  - **Accessibility**: Collapsible triggers need explicit `aria-expanded` if not handled by library (Radix handles it, but good to verify).## 2026-02-02 - UI-010
- Implemented `EmptyState` component with distinct default and demo variants.
- Features: 
  - Discriminated union for Action types (Button vs Link) to prevent invalid states.
  - Runtime href validation for security (prevents javascript: protocol).
  - Explicit accessibility support (heading levels, aria labels, regions).
  - Async action handling with loading states and error callback support.
- Achieved 83% test coverage (100% logic coverage, missed only error logging branch).
- Reviews completed: code-review, silent-failure, security, accessibility (all critical issues fixed).
- **Learnings for future iterations:**
  - **Type Safety**: Use discriminated unions for props that change rendering behavior (e.g. `href` vs `onClick`).
  - **Security**: Next.js `<Link>` does not validate protocols; manual validation is needed for user-supplied URLs.
  - **Accessibility**: Reusable components should allow configuring heading levels (`h1`-`h6`) to fit different page structures.
  - **Async handlers**: Button onClick handlers should be wrapped to catch rejected promises and prevent silent failures.
---

## 2026-02-02 - UI-011
- Implemented `SDKPanel`, `CodeSnippet` components, and `sdk-snippets` data.
- Features: 
  - Syntax highlighting with copy functionality.
  - Framework integration tabs (LangChain, LangGraph, MCP, Custom).
  - Security hardening: input sanitization for snippets, API Key warning.
  - Accessibility: ARIA labels for tabs, feedback for copy actions.
- Achieved 100% test coverage for new components.
- Reviews completed: code-review, silent-failure, security, accessibility.
- **Learnings for future iterations:**
  - **Security**: Client-side ID generation is temporary; label it clearly and sanitize inputs even for "trusted" code generation.
  - **Testing**: `react-syntax-highlighter` splits text into multiple nodes, breaking simple `getByText` matchers. Use regex or `textContent` checks.
  - **Radix UI**: `@radix-ui/react-tabs` is preferred over the generic `radix-ui` package for better compatibility and granularity.
  - **Code Review**: Automated reviews are very effective at catching security issues like insecure randomness and exposed placeholders.
---

## 2026-02-03 - UI-012
- Implemented `RemoteAgentForm` with Shadcn UI and React Hook Form.
- Implemented `useRemoteAgentStore` with persistent storage (excluding secrets).
- Implemented `testConnection` mock.
- Security Features:
  - Excluded `authToken` from local storage persistence.
  - Added warnings about memory-only secret handling.
  - Validated Custom JSON templates.
  - Added XSS protection via React standard escaping.
- Accessibility:
  - Added ARIA labels for Slider and Alerts.
  - Managed focus and live regions for error states.
  - Added `autoComplete="off"` for sensitive fields.
- Test Coverage: 100% for new components and store.
- Reviews completed: code-review, silent-failure, security, accessibility.
- **Learnings for future iterations:**
  - **Zustand Persistence**: Explicitly exclude sensitive fields using `partialize`.
  - **React Hook Form**: Avoid resetting form in `useEffect` with `form` as dependency if possible; or accept it if stable.
  - **Testing**: Use `fireEvent.submit(form)` if button clicks are flaky in JSDOM tests for complex forms.
  - **Testing**: JSDOM + Radix UI Select interaction is tricky; mocking or setting state directly is often cleaner for logic tests.
  - **Security**: Always validate JSON strings in Zod schema with `JSON.parse` check.
---

## 2026-02-03 - UI-013
- Implemented persistent connection status in `useRemoteAgentStore`.
- Enhanced `ConnectionTester` component with store-based status persistence.
- Created standalone `ConnectionStatusIndicator` component for reuse in headers/sidebars.
- Features:
  - Connection status persists across sessions (untested/connected/failed).
  - Relative time display for last tested timestamp.
  - Status automatically resets when endpoint URL changes.
  - Store migration from v1 to v2 for backward compatibility.
- Security & Robustness:
  - Type guard `isConnectionStatus` for runtime validation.
  - Proper cleanup with AbortController for cancelled requests.
  - URL normalization for consistent status tracking.
- Test Coverage: 80% overall (90.69% for ConnectionTester.tsx), 50 tests passing.
- Reviews completed: code-review, silent-failure, security, accessibility.
- **Learnings for future iterations:**
  - **Zustand Migration**: Use version numbers and migrate functions to handle schema changes gracefully.
  - **Testing**: When Vitest module mocking interferes with dynamic imports, use static imports at the top of the file instead.
  - **Git Gotcha**: `frontend/lib/` is ignored by root `.gitignore` - always use `git add -f` for files in this directory.
---

## 2026-02-03 - UI-014
- Implemented `useEventStream` hook for real-time event polling from API.
- Implemented `useEventStreamDemo` hook for demo mode with static data.
- Created `EventStream` component with full UI:
  - Connection status indicator with reconnecting/connected/disconnected states.
  - Metrics display: total events, event rate, new event count.
  - Event type filter buttons with counts.
  - Event cards with type-specific rendering for tool_call, speech, divergence, memory_access, action.
  - Auto-scroll with manual pause control.
  - Export functionality with size limit warnings.
  - Clear and mark-as-read controls.
- Created `frontend/app/agent/monitor/page.tsx` with mode-specific content.
- Fixed critical review issues:
  - Added error logging with context for validation failures.
  - Improved user-facing error messages with actionable guidance.
  - Fixed nested setState by extracting max events check.
  - Added useEffect sync for demo events prop changes.
- Test Coverage: 80.56% overall (82.43% for useEventStream.ts), 221 tests passing.
- Reviews completed: code-review, silent-failure-hunter.
- **Learnings for future iterations:**
  - **React 19 + Vitest**: Test isolation issues can cause "Target container is not a DOM element" errors. Use `cleanup()` in afterEach and consolidate renders.
  - **Testing Labels**: When labels appear in multiple places (filters AND event cards), use `getAllByText` not `getByText`.
  - **Silent Failures**: Always log validation errors even in fallback paths - silent catch blocks mask data quality issues.
  - **useState vs Props**: Hooks using useState(prop) only capture initial value. Use useEffect to sync when props change.
  - **ScrollArea Ref**: shadcn/radix ScrollArea wraps content in a viewport div - ref on outer component may not control scroll.
  - **State Reset**: When config changes invalidate derived state (like connection status), reset it proactively in the setter.
---

## 2026-02-03 - UI-015
- Implemented `Timeline` and `TimelineEvent` components for agent event visualization.
- Created `frontend/components/agent/Timeline.tsx` with:
  - Vertical timeline view with pagination (20 events per page).
  - Event type filter buttons with counts.
  - JSON export with size limit validation (10MB max).
  - Event limit handling (5000 events max with warning).
  - Empty state and error handling.
- Created `frontend/components/agent/TimelineEvent.tsx` with:
  - Expandable/collapsible event cards using Radix Collapsible.
  - Type-specific rendering for all 5 event types: tool_call, memory_access, action, speech, divergence.
  - Relative time display from session start.
  - Severity badges and status icons.
- Test Coverage: 80.6% overall, 50+ tests passing.
- Reviews completed: silent-failure-hunter (6 issues identified - 2 HIGH, 4 MEDIUM).
- **Learnings for future iterations:**
  - **Radix Collapsible**: Use `[data-state]` attribute selector for trigger elements, not `.closest('button')`.
  - **Radix Content**: Radix keeps content in DOM but changes `data-state`. Check attribute instead of DOM presence.
  - **Label Deduplication**: When labels appear in multiple places (filters AND cards), use `getAllByText` with count assertions.
  - **Test Accessibility**: Match exact aria-label text in tests (case-insensitive regex helps).
  - **JSX Closing Tags**: Watch for mismatched closing tags in nested Radix components.
---

## 2026-02-03 - UI-018
- Implemented Attack Template Selector components for Next.js frontend.
- Created `frontend/data/owasp-categories.ts` with:
  - OWASP Agentic Top 10 categories (ASI01-ASI10) data definitions.
  - `AttackTemplate` interface matching backend schema.
  - `TemplateSource` union type for known sources.
  - Helper functions: `getSeverityColor`, `getSeverityBadgeVariant`, `isValidTemplateId`.
- Created `frontend/components/attack/TemplateCard.tsx` with:
  - Grid and list view modes.
  - Severity badges, OWASP category badges, source indicators.
  - Checkbox selection with keyboard navigation (Enter/Space).
  - XSS protection via `escapeHtml` utility.
- Created `frontend/components/attack/TemplateFilters.tsx` with:
  - Search input with length limit (200 chars).
  - OWASP category toggles with counts.
  - Source toggles with counts.
  - Capability filters (tool access, memory access) using Radix Select.
  - Active filter count and clear all functionality.
- Created `frontend/components/attack/TemplateSelector.tsx` with:
  - Grid/list view toggle.
  - Selection summary with OWASP coverage and average severity.
  - Template preview sheet with full details.
  - Selection limit (100 templates max).
- Created `frontend/app/agent/attack/page.tsx` with mock template data.
- Test Coverage: 97 tests, 93% statements, 83% branches.
- Reviews completed: code-review (approve_with_comments), silent-failure-hunter, type-design-analyzer.
- Fixes applied:
  - Added `relative` positioning to Card for absolute check icon.
  - Extracted `escapeHtml` to shared `lib/utils.ts`.
- **Learnings for future iterations:**
  - **Radix Select**: Mock `Element.prototype.scrollIntoView = vi.fn()` for JSDOM tests.
  - **Multiple Buttons**: Use exact match `{ name: 'Select All' }` when filter "All" buttons exist.
  - **Sheet Close**: Multiple close buttons (X icon + text button) need specific selectors.
  - **Git Gotcha**: `frontend/lib/` is ignored by root `.gitignore` - use `git add -f`.
  - **Code Dedup**: Extract shared utilities like `escapeHtml` to `lib/utils.ts` to avoid duplication.
---

---
## 2026-02-03 - UI-004: Settings Page Skeleton
- Implemented comprehensive settings page with 4 tabs (General, Agent Config, API Keys, Appearance)
- Files created:
  - `frontend/stores/settings.ts` - Zustand store with localStorage persistence
  - `frontend/components/providers/ThemeProvider.tsx` - next-themes integration
  - `frontend/app/settings/page.tsx` - Settings page with tab navigation
  - `frontend/components/settings/*.tsx` - Tab content components
  - `frontend/components/ui/switch.tsx` - Radix Switch component
- Technical highlights:
  - Type guards (`isTheme`, `isSettingsTab`) for runtime validation
  - Validation functions for migration (`validateGeneralSettings`, `validateAgentSettings`, `validateAppearanceSettings`)
  - Proper accessibility (ARIA labels, roles, screen-reader-only headings)
  - Hydration-safe patterns with mounted state checks
- Test coverage: 100% for settings store, 96%+ for components
- Post-implementation reviews completed:
  - Code review: Fixed aria-describedby ID mismatch
  - Silent failure check: Added user feedback for clipboard copy failure
  - Security review: No critical issues (demo API key acceptable for skeleton)
  - Accessibility review: Fixed tab trigger ID for aria-labelledby reference
- **Learnings:**
  - Zustand persist middleware migration function receives raw persisted state - must validate before use
  - Radix UI components provide built-in accessibility but explicit IDs needed for cross-references
  - next-themes requires wrapper component to sync with Zustand store state
