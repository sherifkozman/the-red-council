## Codebase Patterns
- safeLocalStorage helper in frontend/lib/persistence/safeLocalStorage.ts for secure storage
- ErrorBoundary component in frontend/components/ErrorBoundary.tsx for fault tolerance
- shadcn/ui components in frontend/components/ui/
- Pydantic models in src/core/ use Field() with descriptions
- All agent classes inherit from base classes in src/agents/
- ChromaDB collections follow naming convention: {domain}_attacks
- Pytest fixtures in tests/conftest.py for common setup
- Use pytest.mark.asyncio for async test functions
- **Concurrency**: Use `src.ui.async_utils.safe_run_async` instead of `asyncio.run` in Streamlit callbacks

## 2026-02-02 - TRC-043
- Implemented `src/ui/components/session_manager.py` with secure session management.
- Features: Save, Save As New, Load, Delete, List, Import.
- Security Hardening:
  - Canonical path check to prevent traversal.
  - Strict UUID validation.
  - Atomic writes (`tempfile` + `os.replace` + `os.fsync` + `chmod`).
  - Hard limits on event count (10k) and file size (50MB).
  - Input sanitization for tags, names, descriptions.
- Created `tests/ui/test_session_manager.py` with 14 tests covering security edge cases.
- Achieved 81% coverage for `session_manager.py`.
- Reviews completed: code-review, security-audit (critical fixes applied).
- **Learnings for future iterations:**
  - **Security**: Always validate paths using `os.path.realpath` against expected directory root.
  - **Security**: Use atomic writes with restrictive permissions for sensitive data files.
  - **Testing**: `pytest-cov` requires careful setup when mocking modules; `patch.dict(sys.modules, ...)` works best.
  - **Mocking**: `json.load` mocking requires understanding how it reads from file-like objects (strings vs bytes).
---
## 2026-02-02 - TRC-044
- Implemented `src/ui/components/shortcuts.py` using JS injection via `st.components.v1.html`.
- Features: Ctrl+E (Eval), Ctrl+R (Report), Ctrl+Shift+D (Demo), Ctrl+Shift+N (New Session), Ctrl+Shift+C (Clear).
- Added `src/ui/async_utils.py` with `safe_run_async` to fix `asyncio.run` issues in Streamlit callbacks.
- Refactored `src/ui/dashboard.py` to use `safe_run_async` and import shortcuts.
- Security & Robustness:
  - Added debounce lock (500ms) to prevent double-clicks.
  - Added `disabled` attribute check before clicking buttons via JS.
  - Used `Ctrl+Shift` modifiers to avoid browser collisions (e.g. New Window).
  - Implemented exact text matching or strict inclusion logic.
- Tests: Created `tests/ui/test_shortcuts.py` validating JS injection content (100% coverage).
- **Learnings for future iterations:**
  - **Streamlit**: `asyncio.run` inside Streamlit callbacks is dangerous/brittle. Always use a helper that checks `get_running_loop()`.
  - **UI Hacks**: JS injection is effective for shortcuts but requires defensive coding (debounce, disabled checks) to be safe.
---
## 2026-02-02 - TRC-043/044 Security Fixes
- Hardened `session_manager.py` against Symlink TOCTOU using `_atomic_write` pattern and `O_NOFOLLOW` checks.
- Fixed FD leak in `load_session`.
- Hardened `SessionMetadata.sanitize` to clamp future dates (current_year + 5).
- Hardened `shortcuts.py` to strictly exclude password fields and restored restricted Tab navigation (currently removed for safety but help text preserved).
- Verified with comprehensive council review.
---

## 2026-02-02 - UI-001
- Implemented AppShell, Sidebar, and MobileNav components.
- Added ErrorBoundary and safeLocalStorage helper.
- Setup Vitest testing infrastructure with >90% coverage.
- Secured localStorage access and improved accessibility (ARIA, focus management).
- **Learnings for future iterations:**
  - **Hydration**: Use `mounted` state to prevent hydration mismatches when reading from localStorage.
  - **Security**: Always wrap localStorage access in try/catch to prevent DoS/crashes.
  - **Accessibility**: Use `aria-current="page"` for active links and `role="navigation"` landmarks.
  - **Testing**: Mocking `usePathname` and `Storage.prototype` works well for integration tests.
